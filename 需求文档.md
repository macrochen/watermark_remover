# 图片去水印应用需求文档

## 1. 项目概述

本项目旨在开发一个 Web 应用，允许用户上传图片，通过交互式选择指定水印区域，并由后端服务器进行自动化处理以去除水印。处理完成后，应用将展示处理前后的效果对比，并提供下载处理后图片的功能。

## 2. 技术栈

*   **后端**: Python + Flask 框架
*   **前端**: HTML, CSS, JavaScript (使用 jQuery 或类似的库简化 DOM 操作和事件处理)
*   **图像处理库**: 建议使用 `opencv-python` 配合 `numpy`，因为其 `inpaint` 功能非常适合此场景。

## 3. 功能需求

### 3.1. 前端 (用户界面与交互)

#### 3.1.1. 图片上传
-   页面核心区域需要有一个明确的“上传图片”按钮或拖拽区域。
-   用户点击后，应弹出文件选择对话框。
-   文件选择器应限制文件类型，仅允许常见的图片格式，如 `.jpg`, `.jpeg`, `.png`。
-   图片上传成功后，应在页面上立即显示原始图片，作为后续操作的基础。
-   需要有加载提示，并在图片过大时给出提示。

#### 3.1.2. 水印区域选择
-   原始图片显示后，用户应能通过鼠标在图片上进行拖拽，以绘制一个矩形选框来定义水印区域。
-   该选框应支持以下操作：
    -   **创建**: 在图片上按下鼠标并拖动以创建选框。
    -   **移动**: 拖动选框主体以移动其位置。
    -   **调整大小**: 拖动选框的边缘或角落来调整其宽度和高度。
-   在选框操作的同时，应能实时捕获并暂存选框的坐标信息（x, y, width, height）。
-   页面上需要有一个“开始处理”或“去除水印”的按钮，用户在确定选区后点击此按钮。

#### 3.1.3. 处理与结果展示
-   点击“开始处理”按钮后，前端应将原始图片文件和选区坐标数据发送到后端 API。
-   在等待后端处理期间，前端界面应显示一个加载动画（如 loading spinner），并禁用操作按钮，以提示用户“正在处理中”。
-   当后端返回处理完成的图片后，加载动画消失。
-   页面上应以“左右对比”或“上下对比”的形式，同时展示处理前的原图和处理后的效果图。
    -   一个推荐的交互方式是提供一个滑块（Slider），用户可以拖动滑块来查看同一位置在处理前后的变化。
-   “下载”按钮此时变为可用状态。

#### 3.1.4. 图片下载
-   结果展示区域需要有一个“下载处理后的图片”按钮。
-   用户点击该按钮后，浏览器应自动下载处理完成的图片。
-   下载的文件名可以默认为 `original_filename_processed.png` 或类似格式。

### 3.2. 后端 (API 与图像处理)

#### 3.2.1. API 接口
-   需要创建一个 API 端点（Endpoint），例如 `/api/remove-watermark`。
-   该接口应接受 `POST` 请求，请求体格式为 `multipart/form-data`，以便同时接收文件和表单数据。
-   请求需要包含以下数据：
    -   `image`: 用户上传的原始图片文件。
    -   `x`: 水印区域的 x 坐标。
    -   `y`: 水印区域的 y 坐标。
    -   `width`: 水印区域的宽度。
    -   `height`: 水印区域的高度。

#### 3.2.2. 图像处理逻辑
-   后端接收到请求后，首先验证所有参数的有效性（如坐标是否为数字，图片文件是否存在等）。
-   使用图像处理库（如 OpenCV）读取上传的图片数据和坐标，并记录其原始格式（如 JPEG, PNG）。
-   根据坐标创建一个与水印区域大小和位置相同的掩码（Mask）。
-   调用库中的图像修复（Inpainting）算法（例如 OpenCV 的 `cv2.inpaint`），传入原始图片和掩码，对指定区域进行重绘。
-   处理完成后，将生成的新图片保存在内存中。
-   **新增**: 保存新图片时，应遵循以下原则：
    -   输出格式应与原始上传的图片格式保持一致。
    -   除水印区域外，图片的其余部分不应有质量损失。对于有损格式（如 JPEG），应使用最高的质量设置进行保存。

#### 3.2.3. API 响应
-   **成功**: 如果处理成功，API 应返回处理后的图片文件。一个常见的做法是将图片数据进行 Base64 编码，并以 JSON 格式返回，方便前端直接渲染。
    ```json
    {
      "status": "success",
      "processed_image": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUg..."
    }
    ```
-   **失败**: 如果处理过程中发生错误（如无效的坐标、文件格式不支持等），API 应返回一个明确的错误信息和相应的 HTTP 状态码（如 400 或 500）。
    ```json
    {
      "status": "error",
      "message": "Invalid coordinates provided."
    }
    ```

## 4. 接口设计 (API Design)

-   **Endpoint**: `POST /api/remove-watermark`
-   **Request**:
    -   **Headers**: `Content-Type: multipart/form-data`
    -   **Body**:
        -   `image` (File): The source image file.
        -   `x` (Number): The x-coordinate of the top-left corner of the watermark area.
        -   `y` (Number): The y-coordinate of the top-left corner of the watermark area.
        -   `width` (Number): The width of the watermark area.
        -   `height` (Number): The height of the watermark area.
-   **Success Response (200 OK)**:
    -   **Body**: JSON object containing the Base64-encoded processed image.
-   **Error Response (400/500)**:
    -   **Body**: JSON object containing an error message.

## 5. 非功能需求

-   **易用性**: 界面应简洁直观，用户无需阅读说明即可完成整个操作流程。
-   **性能**: 后端图像处理应在合理的时间内完成（例如，对于中等大小的图片，处理时间应在 5-10 秒内）。前端应有清晰的等待提示。
-   **兼容性**: 应用应能在主流的现代桌面浏览器（Chrome, Firefox, Safari, Edge）上正常运行。
-   **安全性**: 后端需要对上传的文件类型和大小进行校验，防止恶意文件上传。同时对输入的坐标参数进行严格的类型和范围检查。
